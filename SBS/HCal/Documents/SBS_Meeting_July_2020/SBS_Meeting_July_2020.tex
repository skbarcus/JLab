\documentclass[10pt]{beamer}

%Allow captions for subfigures
\usepackage{subcaption}

%Setup for bibtex.
\usepackage[%
  sorting=none,%
%  backend=bibtex,%
  backend=biber,%
%  style=numeric,%
  style=phys,% 
  pageranges=false,% Print only first page, only works with style=phys
  chaptertitle=false,% for incollections show chapter titles - true for AIP style, false for APS style
  articletitle=true,% Print article title, AIP = false, APS = true
  biblabel=brackets,% Number entries by bracked notation
  related=true,%
  isbn=false,% Don't print ISBN
  doi=false,% Don't print DOI
  url=false,% Don't print URL
  eprint=false,% Don't print eprint information
  hyperref=true,%
%  note=false,%
  firstinits=true,% Use first intials only
  maxnames=3,% Truncate after N names
  minnames=1,% Print at least N names if truncated
%  natbib=true%
 ]{biblatex}
 
%Italicize et al.
 \DefineBibliographyStrings{english}{%
  andothers = {\textit{et al}\adddot}
}

%\addbibresource{bib_Books.bib}

%\begin{filecontents}{\jobname.bib}
%@article{Baird2002,
%author = {Baird, Kevin M and Hoffmann, Errol R and Drury, Colin G},
%journal = {Applied ergonomics},
%month = jan,
%number = {1},
%pages = {9--14},
%title = {{The effects of probe length on Fitts' law.}},
%volume = {33},
%year = {2002}
%}
%\end{filecontents}

\usetheme{metropolis}
\usepackage{appendixnumberbeamer}

\usepackage{booktabs}
\usepackage[scale=2]{ccicons}

\usepackage{pgfplots}
\usepgfplotslibrary{dateplot}

\usepackage{xspace}
\newcommand{\themename}{\textbf{\textsc{metropolis}}\xspace}

%Allows for the making of cells in tables.
\usepackage{makecell}

\usepackage{amsmath}
%\setbeamertemplate{itemize item}[circle]
%\setbeamertemplate{itemize subitem}[-]

\newcommand{\hcal}{HCal}

\title{HCal Update}
\subtitle{}
\date{July 14\textsuperscript{th} 2020}
\author{Scott Barcus and Juan Carlos Cornejo}
\institute{Jefferson Lab}
% \titlegraphic{\hfill\includegraphics[height=1.5cm]{logo.pdf}}

\begin{document}

\maketitle

\begin{frame}{HCal Overview}

    \begin{columns}[T,onlytextwidth]
  	\column{0.5\textwidth}
  	
  	\begin{center}
  	
	\begin{itemize}
		\item Segmented calorimeter designed to detect multiple GeV protons and neutrons.
		\begin{itemize}\itemsep2pt \parskip0pt \parsep0pt
			\item[--] 288 PMT modules (12$\times$24).
			\item[--] Four craneable subassemblies.
			\item[--] 40 layers of iron absorbers.
			\item[--] 40 layers of scintillators.
			\item[--] Weighs $\approx$40 tons.
			\item[--] Wavelength shifter.
			\item[--] Custom light guides.
			\item[--] LED fiber optics system.
		\end{itemize}
		\item Designed for \alert{good time resolution} (goal 0.5 ns).
		\item Energy resolution $\approx$30\%.
	\end{itemize}
	
	\end{center}
	
	\column{0.5\textwidth}
	  \begin{center}
  		\includegraphics[width=1.\linewidth]{/home/skbarcus/JLab/SBS/HCal/Pictures/20190508_170610.jpg}
  	\end{center}
	\begin{center}
  		\includegraphics[width=0.5\linewidth]{/home/skbarcus/Documents/JLab_SS1/Seminar/HCal_External_Clean.png}
  	\end{center}
	\end{columns}

\end{frame}

\begin{frame}{HCal Interior}

    \begin{columns}[T,onlytextwidth]
  	\column{0.48\textwidth}
  	
  	\begin{itemize}
  		\item SBS dipole magnet separates scattered hadrons by charge on HCal's surface.
		\item Iron layers cause the hadrons to shower. 
		\item Scintillator layers sample the energy.
		\item Photons pass through a wavelength shifter increasing detection efficiency.
		\item Custom light guides transport photons to PMTs.
			\begin{itemize}
				\item[--] 192 12 stage 2'' Photonis XP2262 PMTs.
				\item[--] 96 8 stage 2'' Photonis XP2282 PMTs.
			\end{itemize}
  	\end{itemize}

  	\column{0.48\textwidth}
  	
  	\begin{center}
  		\vspace{5mm}
  		\includegraphics[width=1.\linewidth]{/home/skbarcus/Documents/JLab_SS1/Seminar/HCal_Interior_Clean.png}
		\vspace{10mm}
  		\includegraphics[width=1.\linewidth]{/home/skbarcus/JLab/SBS/HCal/Pictures/HCal_Single_Module_Clean.png}
  	\end{center}
  	
	\end{columns}
	
\end{frame}

\begin{frame}{$G_M^n$ Experimental Setup}

	\begin{center}
		\includegraphics[width=1.0\linewidth]{/home/skbarcus/JLab/SBS/HCal/Pictures/GMn_Layout_Clean_Labels.png}
	\end{center}

\end{frame}

\begin{frame}{HCal Hall Layout}

%	\begin{figure}[!ht]
	\begin{center}
		\includegraphics[width=1.0\linewidth]{/home/skbarcus/JLab/SBS/HCal/Schematics/HCal_Hall_Layout_Clean.png}
	\end{center}
%	\caption{
%	{\bf{HCal Layout in Hall A.}} }
%	\label{fig:hall_layout}
%	\end{figure}
\end{frame}


\begin{frame}{HCal Front End}

	\includegraphics[width=1.0\textwidth]{/home/skbarcus/JLab/SBS/HCal/Schematics/My_Maps/HCal_FE.png}

\end{frame}

\begin{frame}{HCal Front End Cont.}

    \begin{columns}[T,onlytextwidth]
  	\column{0.5\textwidth}
	\includegraphics[width=.85\textwidth]{/home/skbarcus/JLab/SBS/HCal/Pictures/HCal_FE_RR1.jpg}
	
	\column{0.5\textwidth}
	\includegraphics[width=.85\textwidth]{/home/skbarcus/JLab/SBS/HCal/Pictures/HCal_FE_RR3.jpg}
	\end{columns}

\end{frame}

\begin{frame}{HCal Front End Cont.}
    \centering
	\includegraphics[width=0.43\textwidth]{/home/skbarcus/JLab/SBS/HCal/Pictures/HCal_FE_RR2.jpg}

\end{frame}

\begin{frame}{HCal DAQ Side}

	\includegraphics[width=1.0\textwidth]{/home/skbarcus/JLab/SBS/HCal/Schematics/My_Maps/HCal_DAQ.png}

\end{frame}

\begin{frame}{HCal DAQ Side Cont.}

    \begin{columns}[T,onlytextwidth]
  	\column{0.5\textwidth}
	\includegraphics[width=.85\textwidth]{/home/skbarcus/JLab/SBS/HCal/Pictures/HCal_DAQ_RR4.jpg}
	
	\column{0.5\textwidth}
	\includegraphics[width=.85\textwidth]{/home/skbarcus/JLab/SBS/HCal/Pictures/HCal_DAQ_RR5.jpg}
	\end{columns}

\end{frame}

\begin{frame}{Data Acquisition System}

    \begin{columns}[T,onlytextwidth]
  	\column{0.5\textwidth}
  	
  	\begin{itemize}
  		\item One VME (temp.) and one VXS crate.
  		\item 18 16-channel fADC250 flash ADCs measure energy.
  			\begin{itemize}
  				\item[--] Takes numerous samples (250 MHz, 4ns).
  				\item[--] Time over threshold measurements extract timing (CFD removes time walk).
  				\item[--] PMT traces fit by Landau.
  			\end{itemize}
  		\item 5 64-channel F1TDCs measure timing.
  		\item \alert{Triggers:}
  			\begin{itemize}
  				\item[--] Scintillator paddle (cosmics).
  				\item[--] Summing module trigger.
  				\item[--] LED pulser trigger.
  				\item[--] BigBite trigger.
  			\end{itemize}
  	\end{itemize}
  	
  	\column{0.5\textwidth}
	\includegraphics[width=1.0\textwidth]{/home/skbarcus/JLab/SBS/HCal/Pictures/Cosmics/Landau_Fit_706_Evt1_2-10_Clean.png}
	
\vspace{10mm}	
	
	\includegraphics[width=1.0\textwidth]{/home/skbarcus/JLab/SBS/HCal/Pictures/Cosmics/Cosmic_Hit_run820_evt16_Arrow.png}

	\end{columns}

\end{frame}

\begin{frame}{TDC Timing Resolution}

	\begin{columns}[T,onlytextwidth]
	\column{0.6\textwidth}
	\begin{itemize}
		\item Require cosmic to be nearly \alert{`vertical'}.
			\begin{itemize}
				\item[--] Vertical F1 signals.
				\item[--] No surrounding F1 signals.
			\end{itemize}
		\item TDC time:
		\begin{equation*}
			\text{T}_{\text{cor}}=\text{T}_{\text{PMT}} - \text{T}_{\text{ref}},
		\end{equation*}
		\begin{equation*}
			\text{T}_{\text{ref}}=\frac{\text{TDC\;1}+\text{TDC\;2}}{2}.
		\end{equation*}
		\item Extract standard deviation of single PMT.
		\begin{equation*}
    			\sigma_{PMT} = \sqrt{|\sigma_{cor}^2-\sigma_{ref}^2|}.
    		\end{equation*}
	\end{itemize}
	
	\column{0.4\textwidth}
	\begin{center}
  		\includegraphics[width=1.6\linewidth]{/home/skbarcus/JLab/SBS/HCal/Analysis/Cosmics/fADC_Timing_Res_3_12_2020/fADC_Timing_Resolution_Cuts.png}
  	\end{center}
  	\end{columns}
  	
  	\begin{center}
  		\includegraphics[width=1.\linewidth]{/home/skbarcus/JLab/SBS/HCal/Pictures/Cosmics/TDC_Timing_run820_6vert_Cropped.png}
  	\end{center}

\end{frame}

\begin{frame}{fADC Timing Resolution}

	\begin{itemize}
		\item Calculated in same manner as TDC timing except ref. channel is a copy of cosmic paddle trigger.
	\end{itemize}
	
	\begin{columns}[T,onlytextwidth]
	\column{0.5\textwidth}
	\begin{itemize}
		\item[--] Fit the leading edge of trigger copies with an exponential.
		\item[--] Two channels to check relative timing of trigger (good).
	\end{itemize}
	\includegraphics[width=1.\linewidth]{/home/skbarcus/JLab/SBS/HCal/Analysis/Cosmics/fADC_Timing_Res_3_12_2020/Double_RefCh_Histos_run820.png}
	
	\column{0.5\textwidth}
		\begin{itemize}
		\item[--] Standard deviation of ref. channel time not quite Gaussian.
		\begin{equation*}
    			\sigma_{PMT} = \sqrt{|\sigma_{cor}^2-\sigma_{ref}^2|}
    		\end{equation*}
	\end{itemize}
	\includegraphics[width=1.\linewidth]{/home/skbarcus/JLab/SBS/HCal/Analysis/Cosmics/fADC_Timing_Res_3_12_2020/RefCh_Timing_Res_run820.png}
	\end{columns}
	
\end{frame}

\begin{frame}{fADC Timing Resolution}
	
	\begin{itemize}
		\item Timing gets worse towards the bottom of the detector. 
			\begin{itemize}
				\item[--] This is due to the ref. time being the cosmic paddle on top of the detector unlike with the TDC.
			\end{itemize}
	\end{itemize}

	\begin{center}
  		\includegraphics<1>[width=1.\linewidth]{/home/skbarcus/JLab/SBS/HCal/Documents/SBS_Meeting_July_2020/fADC_CFD_Timing_Res_run820_12-23.png}
  		\includegraphics<2>[width=1.\linewidth]{/home/skbarcus/JLab/SBS/HCal/Documents/SBS_Meeting_July_2020/fADC_CFD_Timing_Res_run802_108-119.png}
  	\end{center}
  	
\end{frame}

\begin{frame}{Current Status}

	\begin{itemize}
		\item \setbeamercolor{alerted text}{fg=TolLightRed}\alert{DAQ operational and detector fully cabled.}
		\item \setbeamercolor{alerted text}{fg=TolDarkBlue}\alert{Cosmics/calibrations will resume when test lab access is restored.}
		\item \setbeamercolor{alerted text}{fg=mLightBrown}\alert{To do:} \url{https://docs.google.com/document/d/1S--OKOlQLOgP-EP-2nf8LSBLx6Y6d6TAFrWK1UkRxBE/}
	\end{itemize}
	
	\vspace{-2.5mm}
	\begin{columns}[T,onlytextwidth]
	\column{0.5\textwidth}

			\begin{itemize}\itemsep0pt \parskip0pt \parsep0pt
				\item[--] \footnotesize{Grease remaining PMTs.}
				\item[--] \footnotesize{Calibrate relative PMT QEs.}
				\item[--] \footnotesize{Calibrate PMTs with LED pulser/cosmics.}
				\item[--] \footnotesize{Voltage scans.}
				\item[--] \footnotesize{Simulation cosmics vs. real.}
				\item[--] \footnotesize{Upgrade to CODA 3.}
			\end{itemize}
				
				\column{0.5\textwidth}
			\begin{itemize}\itemsep0pt \parskip0pt \parsep0pt
				\item[--] \footnotesize{Online replay.}
				\item[--] \footnotesize{Analysis scripts.}
				\item[--] \footnotesize{Assemble remaining pulser boxes.}
				\item[--] \footnotesize{Fabricate shims.}
				\item[--] \footnotesize{Move to Hall A.}
				\item[--] \footnotesize{Install dry air supply.}
			\end{itemize}
			\end{columns}
				
	\begin{itemize}
		\item \alert{Personnel:}
			\begin{itemize}
				\item[--] 2 postdocs: \setbeamercolor{alerted text}{fg=TolDarkBlue}\alert{Scott Barcus} and \alert{Juan Carlos Cornejo}.
				\item[--] 2 students: \setbeamercolor{alerted text}{fg=TolLightRed}\alert{Vanessa Brio} and \alert{Dimitrii Nikolaev}.
				\item[--] \setbeamercolor{alerted text}{fg=TolDarkBlue}\alert{Brian Quinn} and \alert{Bogdan Wojtsekhowski}.
				\item[--] New collaborators: \setbeamercolor{alerted text}{fg=TolLightRed}\alert{Jim Napolitano}, \alert{Donald Jones}, and \alert{Kent Paschke}.
				\item[--] Prospective collaborators please contact \setbeamercolor{alerted text}{fg=mLightBrown}\alert{skbarcus@jlab.org}.
			\end{itemize}
	\end{itemize}

\end{frame}

\begin{frame}{Acknowledgments}
Thanks to \alert{Gregg Franklin} for his many dedicated years designing and overseeing the construction of {\hcal}. Thanks to \alert{Universit\'{a} di Catania} for their major financial contributions. Many other people and institutions were involved in making {\hcal} possible, including, but not limited to:
    \begin{itemize}
        \item Thanks to the many students who have worked on {\hcal} including \setbeamercolor{alerted text}{fg=TolDarkBlue}\alert{Alexis Ortega}, \alert{So Young Jeon}, \alert{Jorge Pe\~{n}a}, and \alert{Carly Wever}. 
        \item Thanks to \setbeamercolor{alerted text}{fg=mLightBrown}\alert{Alexandre Camsonne} for helping us get the DAQ working and finding all the modules for us.
        \item Thanks to \alert{Chuck Long} for all his help fixing and acquiring things.
        \item Thanks to \alert{Bryan Moffit} for DAQ help.
        \item Thanks also to \alert{Brian Quinn} and \alert{Bogdan Wojtsekhowski}.
        \item Thanks to \setbeamercolor{alerted text}{fg=TolDarkBlue}\alert{Vanessa Brio}, \alert{Cattia Petta}, and \alert{Vincenzo Bellini} for their cosmic commissioning efforts last summer.
        \item Finally welcome to \setbeamercolor{alerted text}{fg=TolLightRed}\alert{Dimitrii Nikolaev}, \alert{Jim Napolitano}, \alert{Donald Jones}, and \alert{Kent Paschke}.
    \end{itemize}

\end{frame}

\begin{frame}{Machine Learning Detector Trigger for HCal LDRD Proposal}

	\begin{itemize}
		\item \alert{Motivation:}
			\begin{itemize}
				\item[--] High background rates obscure physics signals.
			\end{itemize}
		\item \alert{Traditional Solutions:}
			\begin{itemize}
				\item[--] Energy threshold cuts.
				\item[--] Prescaling the data.
				\item[--] Decreasing the beam current.
			\end{itemize}
		\item \alert{Machine Learning Solution:}
			\begin{itemize}
				\item[--] Train a neural network to classify detector events (e.g. p, n, $\pi$).
				\item[--] Use data from G4SBS converted to detector output to train NN.
				\item[--] Load trained NN onto VTP FPGA (fast) to use as HCal trigger.
			\end{itemize}
		\item \alert{Goal:}
			\begin{itemize}
				\item[--] Demonstrate that NNs can be loaded onto VTPs for triggering JLab detectors.
				\item[--] Allow HCal to run at higher current with a cleaner trigger.
			\end{itemize}
	\end{itemize}

\end{frame}

\begin{frame}{Brief Neural Network Overview}

	\vspace{-3mm}
	\begin{center}
  		\includegraphics<1>[width=0.5\linewidth]{/home/skbarcus/JLab/SBS/HCal/Documents/SBS_Meeting_July_2020/neural_network.png}\\
  		\tiny{Image from https://www.astroml.org/book$\_$figures/chapter9/fig$\_$neural$\_$network.html.}
  	\end{center}
  	
  	\vspace{-5mm}
  	\begin{columns}[T,onlytextwidth]
  	\column{0.5\textwidth}
  	
  	\begin{itemize}
  		\item \alert{Feed Forward:}
  			\begin{itemize}%\itemsep100pt%\setlength{\itemsep}{100pt}%[itemsep=4pt]
  				\item[--] Initialize random weights and biases.
  				\item[--] Enter labeled training data to input layer.
  				\item[--] Calculate activation of each neuron (did it fire?).
  				\item[--] Feed forward activation until output layer reached.
  			\end{itemize}
  	\end{itemize}
  	
  	\column{0.5\textwidth}
  	
  	\begin{itemize}
  		\item \alert{Backpropagation:}
  			\begin{itemize}%[itemsep=4pt]
  				\item[--] Evaluate loss function. How wrong is the NN's guess?
  				\item[--] Apply backpropagation algorithm to step back through NN (Chain rule).
  				\item[--] Adjust weights and biases along the gradient of descent (minimize loss function).
  				\item[--] Repeat. 
  			\end{itemize}
  	\end{itemize}

	\end{columns}

\end{frame}

\begin{frame}{Convolutional Neural Networks}

	\begin{center}
  		\includegraphics<1>[width=0.5\linewidth]{/home/skbarcus/JLab/SBS/HCal/Documents/SBS_Meeting_July_2020/CNN.png}\\
  		\tiny{Image from https://www.mdpi.com/2076-3417/9/21/4500.}
  	\end{center}

	\begin{itemize}
		\item Started with image classification. 
		\item Detector traces are essentially images.
			\begin{itemize}
				\item[--] For every event each PMT has numerous fADC samples (like pixels) and a TDC value.
				\item[--] \alert{The location of the PMTs relative to one another is important!}
			\end{itemize}
		\item Dense NNs assume each neuron connection is equally important.
		\item CNNs scan across the image with a kernel creating filters which identify localized features.
		\item Pooling layers decrease the dimensionality to keep things manageable.
	\end{itemize}

\end{frame}

\begin{frame}{Overview of Research Plan}

	\begin{enumerate}
		\item Produce labeled training data from G4SBS.
		\item Convert G4SBS data into detector signals.
		\item Design model architecture (probably CNN).
		\item Train CNN on simulated detector data.
		\item Optimize model hyperparameters (layers, neurons, learning rate ...).
		\item Using hls4ml translate the CNN into FPGA compatible code.
		\item Load CNN onto VTP FPGA where it will use fADC250 and VETROC (3 requested from LDRD) data to form HCal trigger.
		\item Test the trigger under beam conditions and compare its performance with traditional methods.
	\end{enumerate}

\end{frame}

\begin{frame}{Toy Example HCal Neural Network}

	\begin{itemize}
		\item Create NN to identify events with probable cosmic signals. (Note: traditional methods work better than this illustative example.)
		\item \alert{Tools:} ROOT, Python, Numpy, Scikit-learn, Tensorflow, Keras, Google Colaboratory (GPUs).
		\item \alert{Steps:}
			\begin{enumerate}
				\item Format HCal data for NN compatibility.
				\item Split data into train, test, and validate.
			\end{enumerate}
	\end{itemize}

	\begin{center}
  		\includegraphics<1>[width=0.8\linewidth]{/home/skbarcus/JLab/SBS/HCal/Documents/SBS_Meeting_July_2020/Read_Data_Clean.png}
  	\end{center}

\end{frame}

\begin{frame}{Toy Example HCal Neural Network Continued}

  	\begin{columns}[T,onlytextwidth]
  	\column{0.5\textwidth}
  	\begin{center}
  		\includegraphics<1>[width=1.\linewidth]{/home/skbarcus/JLab/SBS/HCal/Documents/SBS_Meeting_July_2020/Event_Display_Run820_Event8_Clean.png}
  	\end{center}
  	
  	\column{0.5\textwidth}
  	\begin{center}
  		\includegraphics<1>[width=1.\linewidth]{/home/skbarcus/JLab/SBS/HCal/Documents/SBS_Meeting_July_2020/fADC_Integrals_Run820_Event8.png}
  	\end{center}
  	
  	\end{columns}

\end{frame}

\begin{frame}{Toy Example HCal Neural Network Continued}

	\begin{enumerate}
		\item[3.] Build model architecture.
		\item[4.] Train neural network.
	\end{enumerate}
	
	\begin{center}
  		\includegraphics<1>[width=0.8\linewidth]{/home/skbarcus/JLab/SBS/HCal/Documents/SBS_Meeting_July_2020/Training_Start_Clean.png}
  	\end{center}
  	
  	\begin{center}
  		\includegraphics<1>[width=0.8\linewidth]{/home/skbarcus/JLab/SBS/HCal/Documents/SBS_Meeting_July_2020/Training_End_Clean.png}
  	\end{center}

\end{frame}

\begin{frame}{Toy Example HCal Neural Network Continued}

	\begin{enumerate}
		\item[5.] Evaluate the model's performance:
		\begin{itemize}
			\item Is loss function decreasing?
			\item Is accuracy increasing?
			\item Check for overfitting.
		\end{itemize}
		\item[6.] Optimize hyperparameters.	
			\begin{itemize}
				\item[--] 98\%+ accuracy with some optimizing.
			\end{itemize}
	\end{enumerate}
	
	  \begin{center}
  		\includegraphics<1>[width=1.\linewidth]{/home/skbarcus/JLab/SBS/HCal/Documents/SBS_Meeting_July_2020/Simple_NN_run820_50k_2layers_128_64_lr0_00001_mini64_epochs250_relu_mse.png}
  	\end{center}

\end{frame}

\begin{frame}{Other Machine Learning Applications}

	\begin{itemize}
		\item \alert{Triggers} for other detectors.
		\item \alert{Data analysis:}
			\begin{itemize}
				\item[--] Event classification.
				\item[--] Track reconstruction.
				\item[--] Cluster finding.
				\item[--] Regression.
			\end{itemize}
		\item \alert{Simulation:}
			\begin{itemize}
				\item[--] Autoencoder/Generative Adversarial Network to more quickly produce G4SBS and other simulation data.
			\end{itemize}
		\item \alert{Unsupervised learning} for event classification.
		\item Explore successful \alert{pretrained model architectures.}
		\item Much more!
	\end{itemize}

\end{frame}

\begin{frame}

	\begin{center}
		\Huge{\alert{Questions?}}
	\end{center}

\end{frame}

\end{document}
